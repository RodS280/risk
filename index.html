<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía Interactiva SBS 11356-2008 & NIIF 9</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estilos personalizados */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .mask-linear { mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); }
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stage-card { transition: all 0.3s ease; }
        .stage-card:hover { transform: translateY(-5px); }
        
        /* Input numérico sin flechas */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 pb-24">

    <!-- NAVBAR -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm/50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between overflow-hidden">
            <div class="flex items-center gap-3 cursor-pointer shrink-0" onclick="switchTab('home')">
                <div class="w-9 h-9 bg-slate-900 rounded-xl flex items-center justify-center shadow-lg shadow-slate-900/20">
                    <i data-lucide="book-open" class="text-white w-5 h-5"></i>
                </div>
                <span class="font-bold text-lg tracking-tight hidden sm:inline">Guía SBS & NIIF 9</span>
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar py-2 px-2 mask-linear" id="nav-buttons">
                <button onclick="switchTab('concepts')" class="nav-btn px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-2 shrink-0 whitespace-nowrap text-slate-500 hover:bg-slate-100" data-tab="concepts">
                    <i data-lucide="lightbulb" class="w-4 h-4"></i> Conceptos
                </button>
                <button onclick="switchTab('alignment')" class="nav-btn px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-2 shrink-0 whitespace-nowrap text-slate-500 hover:bg-slate-100" data-tab="alignment">
                    <i data-lucide="git-merge" class="w-4 h-4"></i> Alineamiento
                </button>
                <button onclick="switchTab('guarantees')" class="nav-btn px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-2 shrink-0 whitespace-nowrap text-slate-500 hover:bg-slate-100" data-tab="guarantees">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> Garantías
                </button>
                <button onclick="switchTab('categories')" class="nav-btn px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-2 shrink-0 whitespace-nowrap text-slate-500 hover:bg-slate-100" data-tab="categories">
                    <i data-lucide="scale" class="w-4 h-4"></i> Categorías
                </button>
                <button onclick="switchTab('calculator')" class="nav-btn px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-2 shrink-0 whitespace-nowrap text-slate-500 hover:bg-slate-100" data-tab="calculator">
                    <i data-lucide="calculator" class="w-4 h-4"></i> Simulador SBS
                </button>
                <button onclick="switchTab('ifrs9_info')" class="nav-btn px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-2 shrink-0 whitespace-nowrap text-slate-500 hover:bg-slate-100" data-tab="ifrs9_info">
                    <i data-lucide="library" class="w-4 h-4"></i> Info NIIF 9
                </button>
                <button onclick="switchTab('ifrs9_sim')" class="nav-btn px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-2 shrink-0 whitespace-nowrap text-slate-500 hover:bg-slate-100" data-tab="ifrs9_sim">
                    <i data-lucide="activity" class="w-4 h-4"></i> Simulador NIIF 9
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="max-w-6xl mx-auto p-4 md:p-8">

        <!-- TAB: HOME -->
        <div id="home" class="tab-content active fade-in space-y-8">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-10 rounded-3xl text-white shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 opacity-10 rounded-full blur-3xl -mr-16 -mt-16"></div>
                <div class="relative z-10">
                    <h1 class="text-4xl md:text-5xl font-black mb-6 tracking-tight">Resolución SBS 11356-2008</h1>
                    <p class="text-xl text-slate-300 max-w-2xl leading-relaxed">
                        Domina el reglamento de riesgos del sistema financiero peruano, incluyendo alineamiento, garantías y NIIF 9.
                    </p>
                    <div class="flex flex-wrap gap-4 mt-8">
                        <button onclick="switchTab('alignment')" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-500 transition-colors flex items-center gap-2 shadow-lg shadow-blue-900/50">
                            <i data-lucide="git-merge" class="w-5 h-5"></i> Aprender Alineamiento
                        </button>
                        <button onclick="switchTab('guarantees')" class="bg-white/10 backdrop-blur-md text-white px-6 py-3 rounded-xl font-bold hover:bg-white/20 transition-colors flex items-center gap-2">
                            Ver Garantías <i data-lucide="shield-check" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div onclick="switchTab('alignment')" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group">
                    <div class="w-10 h-10 bg-slate-50 rounded-lg flex items-center justify-center mb-3 group-hover:bg-blue-50 transition-colors">
                        <i data-lucide="git-merge" class="text-blue-500 w-5 h-5"></i>
                    </div>
                    <h3 class="font-bold text-slate-800">Alineamiento</h3>
                    <p class="text-sm text-slate-500 mt-1">Simulador Multibanco.</p>
                </div>
                <div onclick="switchTab('guarantees')" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group">
                    <div class="w-10 h-10 bg-slate-50 rounded-lg flex items-center justify-center mb-3 group-hover:bg-blue-50 transition-colors">
                        <i data-lucide="shield-check" class="text-indigo-500 w-5 h-5"></i>
                    </div>
                    <h3 class="font-bold text-slate-800">Garantías</h3>
                    <p class="text-sm text-slate-500 mt-1">Preferidas vs Muy Rápidas.</p>
                </div>
                <div onclick="switchTab('calculator')" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group">
                    <div class="w-10 h-10 bg-slate-50 rounded-lg flex items-center justify-center mb-3 group-hover:bg-blue-50 transition-colors">
                        <i data-lucide="calculator" class="text-green-500 w-5 h-5"></i>
                    </div>
                    <h3 class="font-bold text-slate-800">Simulador SBS</h3>
                    <p class="text-sm text-slate-500 mt-1">Calcula provisiones (Regla local).</p>
                </div>
                <div onclick="switchTab('ifrs9_sim')" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group">
                    <div class="w-10 h-10 bg-slate-50 rounded-lg flex items-center justify-center mb-3 group-hover:bg-blue-50 transition-colors">
                        <i data-lucide="activity" class="text-red-600 w-5 h-5"></i>
                    </div>
                    <h3 class="font-bold text-slate-800">Simulador NIIF 9</h3>
                    <p class="text-sm text-slate-500 mt-1">Calculadora de Pérdida Esperada.</p>
                </div>
            </div>
        </div>

        <!-- TAB: ALIGNMENT (SIMULADOR MULTIBANCO) -->
        <div id="alignment" class="tab-content slide-up space-y-8">
            <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                <div class="flex items-center gap-4 mb-6">
                    <div class="p-3 bg-blue-100 rounded-xl">
                        <i data-lucide="git-merge" class="text-blue-600 w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">Alineamiento del Deudor</h2>
                        <p class="text-slate-500">Regla de oro: El riesgo es del cliente, no del producto ni del banco.</p>
                    </div>
                </div>
                <p class="text-lg text-slate-700 leading-relaxed max-w-4xl">
                    La norma SBS establece que si un deudor mantiene obligaciones con varios bancos, su clasificación debe ser la de <strong>mayor riesgo</strong> asignada por cualquiera de ellos, siempre que dicho banco tenga al menos el <strong>20% de la deuda total</strong> del sistema.
                </p>
            </div>

            <!-- 1. ALINEAMIENTO INTERNO -->
            <div class="bg-white p-6 md:p-8 rounded-3xl border border-slate-200 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-50 rounded-full -mr-16 -mt-16"></div>
                <h3 class="text-2xl font-bold text-indigo-900 mb-6 flex items-center gap-2">
                    <i data-lucide="user" class="w-6 h-6"></i> 1. Alineamiento Interno (Mismo Banco)
                </h3>
                
                <div class="grid md:grid-cols-3 gap-8 items-center">
                    <div class="space-y-4">
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <label class="block text-xs font-bold text-indigo-800 uppercase mb-2">Producto A: Tarjeta de Crédito</label>
                            <select id="prodA_class" class="w-full p-2 rounded-lg border border-indigo-200 text-sm outline-none">
                                <option value="0">Normal (Al día)</option>
                                <option value="1">CPP (Problemas Potenciales)</option>
                                <option value="2">Deficiente</option>
                                <option value="3">Dudoso</option>
                                <option value="4" selected>Pérdida (Muy atrasado)</option>
                            </select>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                            <label class="block text-xs font-bold text-green-800 uppercase mb-2">Producto B: Hipotecario</label>
                            <select id="prodB_class" class="w-full p-2 rounded-lg border border-green-200 text-sm outline-none">
                                <option value="0" selected>Normal (Pagado puntualmente)</option>
                                <option value="1">CPP</option>
                                <option value="2">Deficiente</option>
                                <option value="3">Dudoso</option>
                                <option value="4">Pérdida</option>
                            </select>
                            <p class="text-xs text-green-600 mt-2 italic">"¡Pero si yo pago mi casa puntual!"</p>
                        </div>
                    </div>

                    <div class="flex flex-col items-center justify-center text-indigo-300">
                        <i data-lucide="arrow-right" class="w-8 h-8 hidden md:block"></i>
                        <i data-lucide="arrow-down" class="w-8 h-8 md:hidden"></i>
                    </div>

                    <div class="bg-slate-900 text-white p-6 rounded-2xl text-center shadow-lg">
                        <span class="text-slate-400 text-xs font-bold uppercase">Calificación Final en el Banco</span>
                        <div id="internal_result" class="text-3xl font-black mt-2 mb-1 text-red-400">Pérdida</div>
                        <div class="text-xs text-slate-300 border-t border-slate-700 pt-2 mt-2">
                            El banco debe reportar <strong>ambos</strong> créditos como Pérdida a la SBS.
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ALINEAMIENTO EXTERNO (MULTIBANCO) -->
            <div class="bg-white p-6 md:p-8 rounded-3xl border border-slate-200 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16"></div>
                <h3 class="text-2xl font-bold text-blue-900 mb-6 flex items-center gap-2">
                    <i data-lucide="globe" class="w-6 h-6"></i> 2. Alineamiento Externo (Multibanco)
                </h3>
                <p class="text-sm text-slate-600 mb-6">
                    Simula la deuda del cliente en el sistema financiero. Agrega bancos y ve cómo afecta la calificación. Recuerda la regla del <strong>> 20%</strong>.
                </p>

                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Column 1: Bank List -->
                    <div class="space-y-4">
                        <!-- Mi Banco (Fixed) -->
                        <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-100 flex justify-between items-center shadow-sm">
                            <div>
                                <div class="font-bold text-blue-900 text-sm flex items-center gap-2"><i data-lucide="building" class="w-4 h-4"></i> Mi Banco (Nosotros)</div>
                                <div class="text-xs text-blue-600 mt-1">Participación Residual: <span id="my_share_display" class="font-bold text-lg">30%</span></div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold text-blue-400 uppercase block mb-1">Calif.</span>
                                <select id="my_bank_cat" class="bg-white border border-blue-200 text-xs p-1.5 rounded-lg font-bold text-blue-700 outline-none" onchange="calcExternalAlignment()">
                                    <option value="0">Normal</option>
                                    <option value="1">CPP</option>
                                    <option value="2">Deficiente</option>
                                    <option value="3">Dudoso</option>
                                    <option value="4">Pérdida</option>
                                </select>
                            </div>
                        </div>

                        <!-- External Banks List -->
                        <div id="external_banks_container" class="space-y-3 max-h-80 overflow-y-auto pr-2 no-scrollbar">
                            <!-- JS will render rows here -->
                        </div>

                        <!-- Add Button & Warning -->
                        <button onclick="addExternalBank()" class="w-full py-3 border-2 border-dashed border-slate-300 text-slate-500 rounded-xl font-bold text-sm hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> Agregar Banco Externo
                        </button>
                        <div id="share_warning" class="hidden p-2 bg-red-100 text-red-700 text-xs font-bold rounded-lg text-center animate-pulse border border-red-200">
                            ¡Cuidado! La suma de participaciones externas supera el 100%.
                        </div>
                    </div>

                    <!-- Column 2: Result -->
                    <div class="bg-slate-900 text-white p-8 rounded-3xl flex flex-col justify-center items-center text-center shadow-xl">
                        <span class="text-slate-400 text-xs font-bold uppercase mb-6 tracking-widest">Resultado del Alineamiento</span>
                        
                        <div id="align_icon_container" class="mb-4 transform scale-110 transition-transform">
                            <!-- JS inject icon -->
                        </div>

                        <div id="external_result_title" class="text-3xl font-black mb-3">...</div>
                        <p id="external_result_desc" class="text-sm text-slate-300 leading-relaxed px-4">
                            Calculando impacto...
                        </p>
                        
                        <div class="mt-8 pt-6 border-t border-slate-800 w-full text-left">
                            <h4 class="text-xs text-slate-500 font-bold uppercase mb-3">Resumen de Reglas</h4>
                            <ul class="space-y-2 text-xs text-slate-400">
                                <li class="flex gap-2"><i data-lucide="check" class="w-3 h-3 text-green-500"></i> Si banco externo tiene &lt; 20%, no alinea obligatoriamente.</li>
                                <li class="flex gap-2"><i data-lucide="alert-triangle" class="w-3 h-3 text-red-500"></i> Si banco externo tiene &ge; 20%, alinea a su categoría si es peor.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: CONCEPTOS BASICOS -->
        <div id="concepts" class="tab-content slide-up space-y-6">
            <!-- (Contenido igual a v7, omitido por brevedad en la vista previa) -->
            <!-- ... -->
             <div class="flex items-center gap-3 mb-6">
                <div class="p-3 bg-indigo-100 rounded-xl">
                    <i data-lucide="lightbulb" class="text-indigo-600 w-8 h-8"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-slate-900">Conceptos Fundamentales</h2>
                    <p class="text-slate-500">Todo lo que necesitas saber antes de empezar.</p>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
                    <h3 class="text-lg font-bold text-indigo-700 flex items-center gap-2 mb-3">
                        <i data-lucide="piggy-bank" class="w-5 h-5"></i> ¿Qué es una Provisión?
                    </h3>
                    <p class="text-slate-600 text-sm leading-relaxed mb-4">
                        Imagina que prestas S/ 100 a un amigo. Hay un riesgo de que no te pague. Para protegerte, guardas S/ 5 en una alcancía. Esa reserva es la <strong>provisión</strong>.
                    </p>
                    <div class="bg-indigo-50 p-4 rounded-xl text-sm space-y-2">
                        <p><strong>En los Bancos:</strong> Es un gasto contable obligatorio. Reduce las utilidades hoy para proteger el dinero de los ahorristas mañana.</p>
                        <ul class="list-disc pl-4 text-slate-600 mt-2">
                            <li><strong>Provisión Genérica:</strong> El "por si acaso" para clientes sanos.</li>
                            <li><strong>Provisión Específica:</strong> La reserva para clientes que YA tienen problemas.</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
                    <h3 class="text-lg font-bold text-green-700 flex items-center gap-2 mb-3">
                        <i data-lucide="shield-check" class="w-5 h-5"></i> ¿Qué es la Garantía?
                    </h3>
                    <p class="text-slate-600 text-sm leading-relaxed mb-4">
                        Es el "Plan B" del banco. Si el deudor no paga con su dinero (fuente principal), el banco vende la garantía para recuperar el préstamo.
                    </p>
                    <div class="mt-4">
                        <button onclick="switchTab('guarantees')" class="w-full py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 transition-colors">
                            Ver explicación detallada y ejemplos &rarr;
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
                    <h3 class="text-lg font-bold text-blue-700 flex items-center gap-2 mb-3">
                        <i data-lucide="arrow-right-left" class="w-5 h-5"></i> Directos vs Indirectos
                    </h3>
                    <div class="space-y-4">
                        <div class="flex gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center shrink-0 font-bold text-blue-600">D</div>
                            <div>
                                <h4 class="font-bold text-sm text-slate-800">Crédito Directo</h4>
                                <p class="text-xs text-slate-500">Dinero real que sale del banco. El riesgo es inmediato.<br><em>Ej: Préstamos personales, Hipotecas, Tarjetas de crédito.</em></p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center shrink-0 font-bold text-blue-600">I</div>
                            <div>
                                <h4 class="font-bold text-sm text-slate-800">Crédito Indirecto (Contingente)</h4>
                                <p class="text-xs text-slate-500">Es una garantía o aval. El banco no desembolsa dinero hoy, pero se compromete a pagar si el cliente falla ante un tercero.<br><em>Ej: Carta Fianza.</em></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
                    <h3 class="text-lg font-bold text-purple-700 flex items-center gap-2 mb-3">
                        <i data-lucide="users" class="w-5 h-5"></i> Tipos de Deudores
                    </h3>
                    <div class="space-y-3">
                        <div class="border-l-4 border-purple-500 pl-3">
                            <h4 class="font-bold text-sm text-slate-800">Deudor Minorista</h4>
                            <p class="text-xs text-slate-500">Personas y pequeños negocios. Son muchos y de montos pequeños.<br><strong>¿Cómo se evalúan?</strong> Principalmente por su comportamiento de pago (Días de atraso).</p>
                        </div>
                        <div class="border-l-4 border-indigo-500 pl-3">
                            <h4 class="font-bold text-sm text-slate-800">Deudor No Minorista (Mayorista)</h4>
                            <p class="text-xs text-slate-500">Empresas medianas y grandes. Son menos pero de montos altos.<br><strong>¿Cómo se evalúan?</strong> Análisis financiero profundo (Flujo de caja, entorno económico, gerencia).</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: GARANTIAS DETALLE -->
        <div id="guarantees" class="tab-content slide-up space-y-8">
            <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                <div class="flex items-center gap-4 mb-6">
                    <div class="p-3 bg-indigo-100 rounded-xl">
                        <i data-lucide="shield-check" class="text-indigo-600 w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">Las Garantías en la Norma SBS</h2>
                        <p class="text-slate-500">El mecanismo principal para reducir las provisiones bancarias.</p>
                    </div>
                </div>
                <p class="text-lg text-slate-700 leading-relaxed max-w-4xl">
                    Para la SBS, no todas las garantías son iguales. La normativa las clasifica según <strong>qué tan rápido y seguro</strong> se pueden convertir en dinero en efectivo para cubrir la deuda.
                </p>
            </div>

            <!-- COMPARATIVE CARDS -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- PREFERIDA -->
                <div class="bg-white p-6 rounded-2xl border-t-4 border-blue-500 shadow-md">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-slate-800">Garantía Preferida</h3>
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">Tabla 2</span>
                    </div>
                    <p class="text-sm text-slate-600 mb-4 h-16">
                        Son bienes de valor duradero, pero que toman tiempo en venderse (proceso judicial o remate).
                    </p>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Ejemplos Comunes:</h4>
                        <ul class="space-y-2">
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="home" class="w-4 h-4 text-blue-500"></i> Primera Hipoteca de Inmuebles</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="car" class="w-4 h-4 text-blue-500"></i> Prenda Vehicular</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="package" class="w-4 h-4 text-blue-500"></i> Warrants (Mercadería en almacén)</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="settings" class="w-4 h-4 text-blue-500"></i> Maquinaria Industrial</li>
                        </ul>
                    </div>
                </div>

                <!-- MUY RAPIDA -->
                <div class="bg-white p-6 rounded-2xl border-t-4 border-green-500 shadow-md">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-slate-800">G. Muy Rápida Realización</h3>
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">Tabla 3</span>
                    </div>
                    <p class="text-sm text-slate-600 mb-4 h-16">
                        Son activos que son prácticamente "dinero en mano". Se pueden liquidar casi inmediatamente sin perder valor.
                    </p>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Ejemplos Comunes:</h4>
                        <ul class="space-y-2">
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="coins" class="w-4 h-4 text-green-500"></i> Depósitos en Efectivo (en el mismo banco)</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="gem" class="w-4 h-4 text-green-500"></i> Oro (Lingotes)</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="file-check" class="w-4 h-4 text-green-500"></i> Cartas Fianza de Bancos de 1ra Categoría</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="landmark" class="w-4 h-4 text-green-500"></i> Bonos del Tesoro Público</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- IMPACT TABLE -->
            <div class="bg-slate-900 text-white p-8 rounded-3xl shadow-xl">
                <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i data-lucide="trending-down" class="text-green-400 w-6 h-6"></i> ¿Cómo aplica el descuento?
                </h3>
                <p class="text-slate-400 mb-6 max-w-2xl">
                    Observa cómo la exigencia de provisión (el dinero que el banco congela) disminuye drásticamente si el cliente presenta una garantía.
                </p>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="pb-3 text-slate-400 font-normal">Categoría de Riesgo</th>
                                <th class="pb-3 font-bold text-red-400">Sin Garantía</th>
                                <th class="pb-3 font-bold text-blue-400">Con G. Preferida</th>
                                <th class="pb-3 font-bold text-green-400">Con G. Muy Rápida</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            <tr>
                                <td class="py-3 font-bold">Normal</td>
                                <td class="py-3 text-slate-300">0.7% - 1%</td>
                                <td class="py-3 text-slate-300">0.7% - 1%</td>
                                <td class="py-3 text-slate-300">0.7% - 1%</td>
                            </tr>
                            <tr>
                                <td class="py-3 font-bold">Con Problemas (CPP)</td>
                                <td class="py-3 text-red-400 font-bold">5.00%</td>
                                <td class="py-3 text-blue-400 font-bold">2.50%</td>
                                <td class="py-3 text-green-400 font-bold">1.25%</td>
                            </tr>
                            <tr>
                                <td class="py-3 font-bold">Deficiente</td>
                                <td class="py-3 text-red-400 font-bold">25.00%</td>
                                <td class="py-3 text-blue-400 font-bold">12.50%</td>
                                <td class="py-3 text-green-400 font-bold">6.25%</td>
                            </tr>
                            <tr>
                                <td class="py-3 font-bold">Dudoso</td>
                                <td class="py-3 text-red-400 font-bold">60.00%</td>
                                <td class="py-3 text-blue-400 font-bold">30.00%</td>
                                <td class="py-3 text-green-400 font-bold">15.00%</td>
                            </tr>
                            <tr>
                                <td class="py-3 font-bold">Pérdida</td>
                                <td class="py-3 text-red-400 font-bold">100.00%</td>
                                <td class="py-3 text-blue-400 font-bold">60.00%</td>
                                <td class="py-3 text-green-400 font-bold">30.00%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-slate-500 mt-4 italic">* Nota: En categoría Pérdida con garantía, el banco debe provisionar el 100% de la parte NO cubierta, y solo aplica el descuento a la parte cubierta.</p>
            </div>
        </div>

        <!-- TAB: CATEGORIES -->
        <div id="categories" class="tab-content slide-up space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h2 class="text-2xl font-bold">Matriz de Clasificación SBS</h2>
                <div class="bg-white p-1 rounded-xl border border-slate-200 shadow-sm flex">
                    <button onclick="setCatFilter('no_minorista')" class="cat-filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-blue-100 text-blue-700" id="btn-no_minorista">
                        Empresas (Mayorista)
                    </button>
                    <button onclick="setCatFilter('minorista')" class="cat-filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors text-slate-500 hover:bg-slate-50" id="btn-minorista">
                        Consumo/Micro (Minorista)
                    </button>
                    <button onclick="setCatFilter('hipotecario')" class="cat-filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors text-slate-500 hover:bg-slate-50" id="btn-hipotecario">
                        Hipotecario
                    </button>
                </div>
            </div>
            <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl text-blue-800 text-sm">
                Mostrando criterios para: <strong id="cat-rules-title">Créditos Corporativos, Grandes y Medianas Empresas</strong>
            </div>
            <div class="grid gap-4" id="categories-list"></div>
        </div>

        <!-- TAB: CALCULATOR (SBS) -->
        <div id="calculator" class="tab-content slide-up space-y-6">
            <!-- (Contenido igual a v7, omitido por brevedad) -->
            <!-- ... -->
             <div class="bg-white p-6 md:p-8 rounded-3xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="calculator" class="text-green-600 w-6 h-6"></i> Simulador SBS (Local)
                    </h2>
                    <span class="text-xs font-bold px-3 py-1 bg-green-100 text-green-700 rounded-full">Regla Fija</span>
                </div>
                <div class="grid lg:grid-cols-2 gap-10">
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">1. Tipo de Cartera</label>
                            <select id="calcType" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-green-500 transition-all">
                                <option value="comercial">Corporativos / Gran Empresa</option>
                                <option value="mediana">Mediana Empresa</option>
                                <option value="pequena">Pequeña / Micro Empresa</option>
                                <option value="consumo_rev">Consumo Revolvente</option>
                                <option value="consumo_no_rev">Consumo No Revolvente</option>
                                <option value="hipotecario">Hipotecario Vivienda</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">2. Clasificación del Cliente</label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="calc-cat-buttons"></div>
                        </div>
                        <div id="procyclical-control" class="bg-blue-50 p-5 rounded-2xl flex items-center justify-between border border-blue-100">
                            <div>
                                <h4 class="font-bold text-blue-900 flex items-center gap-2">
                                    <i data-lucide="trending-up" class="w-4 h-4"></i> Regla Procíclica
                                </h4>
                                <p class="text-xs text-blue-700 mt-1">Se activa cuando el PBI crece &gt; 5%.</p>
                            </div>
                            <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="isProcyclical" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-blue-200" checked>
                                <label for="isProcyclical" class="toggle-label block overflow-hidden h-6 rounded-full bg-blue-200 cursor-pointer"></label>
                            </div>
                        </div>
                        <div id="guarantee-control" class="space-y-2 hidden">
                            <label class="block text-sm font-bold text-slate-700">3. Mitigadores de Riesgo (Garantías)</label>
                            <select id="hasGuarantee" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-green-500 transition-all">
                                <option value="none">Sin Garantía (Tabla 1 - Tasa Máxima)</option>
                                <option value="preferida">Garantía Preferida (Tabla 2 - 50% desc)</option>
                                <option value="muy_rapida">Muy Rápida Realización (Tabla 3 - 75% desc)</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-slate-900 rounded-[2rem] p-8 text-white flex flex-col justify-between relative overflow-hidden shadow-2xl">
                        <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-green-900 via-slate-900 to-slate-900 opacity-50"></div>
                        <div class="relative z-10">
                            <span class="text-green-400 uppercase tracking-widest text-xs font-bold mb-2 block">Requerimiento de Provisión</span>
                            <div class="flex items-baseline gap-2">
                                <div id="resultTotal" class="text-7xl font-black tracking-tighter">0.00</div>
                                <span class="text-2xl font-bold text-slate-400">%</span>
                            </div>
                            <p class="text-slate-400 text-sm mt-2">del saldo insoluto del crédito</p>
                        </div>
                        <div class="relative z-10 w-full space-y-3 mt-8 bg-white/5 p-4 rounded-xl backdrop-blur-sm border border-white/10">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-300">Provisión Genérica Base</span>
                                <span id="resultBase" class="font-mono font-bold">0.00%</span>
                            </div>
                            <div id="rowProc" class="flex justify-between text-sm">
                                <span class="text-blue-300 flex items-center gap-1"><i data-lucide="trending-up" class="w-3 h-3"></i> Componente Procíclico</span>
                                <span id="resultProc" class="font-mono font-bold text-blue-300">+0.00%</span>
                            </div>
                            <div id="rowSpecific" class="flex justify-between text-sm">
                                <span class="text-orange-300 flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Riesgo Específico</span>
                                <span id="resultSpecific" class="font-mono font-bold text-orange-300">0.00%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: IFRS 9 INFO (TEORÍA) -->
        <div id="ifrs9_info" class="tab-content slide-up space-y-8">
            <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                <div class="flex items-center gap-4 mb-6">
                    <div class="p-3 bg-red-100 rounded-xl">
                        <i data-lucide="library" class="text-red-600 w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">Teoría NIIF 9: El Camino del Deterioro</h2>
                        <p class="text-slate-500">¿Cómo clasifica la NIIF 9 la salud de un crédito?</p>
                    </div>
                </div>
                <p class="text-lg text-slate-700 leading-relaxed max-w-4xl">
                    La NIIF 9 no espera a que el cliente deje de pagar para actuar. Clasifica los créditos en 3 "Estadios" (Stages) dependiendo de qué tanto ha subido su riesgo desde que se otorgó el crédito.
                </p>
            </div>

            <!-- TRADUCTOR / MAPEO -->
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="arrow-right-left" class="text-indigo-600 w-5 h-5"></i> Traductor: De Clasificación SBS a NIIF 9
                </h3>
                <p class="text-sm text-slate-600 mb-6">
                    Aunque son normas distintas, existe una correlación basada en los días de atraso. Aquí te mostramos cómo "traducir" tu clasificación local al estándar internacional.
                </p>
                
                <div class="overflow-hidden rounded-xl border border-slate-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                            <tr>
                                <th class="p-4">Días de Atraso</th>
                                <th class="p-4">Clasificación SBS (Local)</th>
                                <th class="p-4">Estadio NIIF 9 (Internacional)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">
                            <tr class="hover:bg-green-50/50 transition-colors">
                                <td class="p-4 font-mono text-slate-600">0 - 30 días</td>
                                <td class="p-4">
                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                                        <span class="w-2 h-2 rounded-full bg-green-500"></span> Normal
                                    </span>
                                </td>
                                <td class="p-4 font-bold text-green-700">Stage 1 (Performing)</td>
                            </tr>
                            <tr class="hover:bg-yellow-50/50 transition-colors">
                                <td class="p-4 font-mono text-slate-600">31 - 90 días</td>
                                <td class="p-4">
                                    <div class="flex flex-col gap-1">
                                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800 w-fit">
                                            <span class="w-2 h-2 rounded-full bg-yellow-500"></span> CPP
                                        </span>
                                    </div>
                                </td>
                                <td class="p-4">
                                    <div class="font-bold text-yellow-700">Stage 2 (Under-Performing)</div>
                                    <div class="text-xs text-slate-500 mt-1">El riesgo ha aumentado significativamente.</div>
                                </td>
                            </tr>
                            <tr class="hover:bg-red-50/50 transition-colors">
                                <td class="p-4 font-mono text-slate-600">> 90 días</td>
                                <td class="p-4">
                                    <div class="flex flex-wrap gap-1">
                                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-800">Deficiente</span>
                                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-orange-200 text-orange-900">Dudoso</span>
                                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">Pérdida</span>
                                    </div>
                                </td>
                                <td class="p-4">
                                    <div class="font-bold text-red-700">Stage 3 (Default)</div>
                                    <div class="text-xs text-slate-500 mt-1">Crédito deteriorado. Pérdida objetiva.</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- STAGES VISUALIZATION -->
            <div class="space-y-6">
                <!-- STAGE 1 -->
                <div class="stage-card bg-white p-6 rounded-2xl border-l-8 border-green-500 shadow-sm relative overflow-hidden">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="shrink-0 flex flex-col items-center justify-center w-24">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-2xl font-black text-green-600">1</div>
                            <span class="text-xs font-bold text-green-600 uppercase mt-2">Saludable</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-slate-900 mb-2">Stage 1: Riesgo Normal (Performing)</h3>
                            <p class="text-slate-600 mb-4">
                                <strong>El escenario ideal.</strong> El cliente paga bien y su situación financiera es estable. El riesgo no ha subido significativamente desde que le dimos el crédito.
                            </p>
                            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                                <h4 class="text-sm font-bold text-green-800 mb-2 flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4"></i> ¿Cuánto provisiono?</h4>
                                <p class="text-sm text-slate-700">
                                    <strong>Pérdida Esperada a 12 Meses.</strong><br>
                                    Calculo lo que podría perder solo si el cliente falla en el <em>próximo año</em>.
                                    <br><span class="text-xs italic text-slate-500">(Ejemplo: Si presto 100 y la probabilidad de fallo anual es 1%, guardo 1).</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TRANSITION INDICATOR -->
                <div class="flex justify-center items-center gap-4 text-slate-400">
                    <i data-lucide="arrow-down" class="w-6 h-6 animate-bounce"></i>
                    <div class="bg-yellow-100 px-4 py-1 rounded-full text-xs font-bold text-yellow-800 border border-yellow-200">
                        SICR: Incremento Significativo del Riesgo de Crédito (El "Semáforo")
                    </div>
                    <i data-lucide="arrow-down" class="w-6 h-6 animate-bounce"></i>
                </div>

                <!-- STAGE 2 -->
                <div class="stage-card bg-white p-6 rounded-2xl border-l-8 border-yellow-500 shadow-sm relative overflow-hidden">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="shrink-0 flex flex-col items-center justify-center w-24">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center text-2xl font-black text-yellow-600">2</div>
                            <span class="text-xs font-bold text-yellow-600 uppercase mt-2">Alerta</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-slate-900 mb-2">Stage 2: Riesgo Aumentado (Under-Performing)</h3>
                            <p class="text-slate-600 mb-4">
                                <strong>La luz amarilla.</strong> El cliente quizá aún paga, pero algo grave pasó: perdió el empleo, su sector entró en crisis o se atrasó más de 30 días. El riesgo subió mucho comparado al inicio.
                            </p>
                            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                                <h4 class="text-sm font-bold text-yellow-800 mb-2 flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4"></i> ¿Cuánto provisiono? (¡EL GOLPE!)</h4>
                                <p class="text-sm text-slate-700">
                                    <strong>Pérdida Esperada de Por Vida (Lifetime).</strong><br>
                                    Calculo lo que podría perder durante <em>toda la vida restante del crédito</em> (5, 10, 20 años). La provisión se multiplica drásticamente.
                                    <br><span class="text-xs italic text-slate-500">(Ejemplo: Si le faltan 5 años al crédito, ya no guardo 1, podría tener que guardar 5 o más).</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TRANSITION INDICATOR -->
                <div class="flex justify-center items-center gap-4 text-slate-400">
                    <i data-lucide="arrow-down" class="w-6 h-6"></i>
                    <div class="bg-red-100 px-4 py-1 rounded-full text-xs font-bold text-red-800 border border-red-200">
                        Default / Incumplimiento (> 90 días de atraso)
                    </div>
                    <i data-lucide="arrow-down" class="w-6 h-6"></i>
                </div>

                <!-- STAGE 3 -->
                <div class="stage-card bg-white p-6 rounded-2xl border-l-8 border-red-600 shadow-sm relative overflow-hidden">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="shrink-0 flex flex-col items-center justify-center w-24">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-2xl font-black text-red-600">3</div>
                            <span class="text-xs font-bold text-red-600 uppercase mt-2">Deteriorado</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-slate-900 mb-2">Stage 3: Incumplimiento (Non-Performing)</h3>
                            <p class="text-slate-600 mb-4">
                                <strong>La luz roja.</strong> El crédito está en default. El cliente tiene atrasos mayores a 90 días o está en quiebra. Ya es una pérdida objetiva.
                            </p>
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                                <h4 class="text-sm font-bold text-red-800 mb-2 flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4"></i> ¿Cuánto provisiono?</h4>
                                <p class="text-sm text-slate-700">
                                    <strong>Pérdida Esperada Lifetime + Intereses sobre Neto.</strong><br>
                                    Igual que en Stage 2 (toda la vida), pero contablemente los intereses que genera el crédito ya no se calculan sobre la deuda total, sino sobre lo que realmente espero recuperar (Neto).
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FÓRMULA SIMPLIFICADA -->
            <div class="mt-8 bg-slate-900 text-white p-8 rounded-3xl shadow-xl overflow-hidden relative">
                <div class="relative z-10">
                    <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="function-square" class="text-blue-400 w-6 h-6"></i> La Fórmula Mágica (Explicada fácil)
                    </h3>
                    <div class="grid md:grid-cols-3 gap-6 text-center">
                        <div class="bg-white/10 p-4 rounded-xl">
                            <div class="text-3xl font-black text-blue-400 mb-2">PD</div>
                            <div class="text-sm font-bold mb-1">Probabilidad de Default</div>
                            <p class="text-xs text-slate-300">"¿Qué tan probable es que no me pague?"</p>
                        </div>
                        <div class="self-center text-xl font-bold text-slate-500">X</div>
                        <div class="bg-white/10 p-4 rounded-xl">
                            <div class="text-3xl font-black text-purple-400 mb-2">LGD</div>
                            <div class="text-sm font-bold mb-1">Severidad de Pérdida</div>
                            <p class="text-xs text-slate-300">"Si no paga, ¿cuánto pierdo realmente después de vender las garantías?"</p>
                        </div>
                        <div class="self-center text-xl font-bold text-slate-500">X</div>
                        <div class="bg-white/10 p-4 rounded-xl">
                            <div class="text-3xl font-black text-orange-400 mb-2">EAD</div>
                            <div class="text-sm font-bold mb-1">Exposición</div>
                            <p class="text-xs text-slate-300">"¿Cuánto me deberá en ese momento?"</p>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <span class="text-2xl font-bold text-white">= ECL (Pérdida Esperada)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: IFRS 9 SIMULATOR (PRÁCTICA) -->
        <div id="ifrs9_sim" class="tab-content slide-up space-y-8">
            <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                <div class="flex items-center gap-4 mb-6">
                    <div class="p-3 bg-red-100 rounded-xl">
                        <i data-lucide="activity" class="text-red-600 w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">Simulador NIIF 9</h2>
                        <p class="text-slate-500">Pon a prueba la fórmula: ECL = PD × LGD × EAD</p>
                    </div>
                </div>
                <div class="grid lg:grid-cols-2 gap-10">
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                            <label class="block text-sm font-bold text-blue-900 mb-2">1. Exposición (EAD)</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-blue-400 font-bold">$</span>
                                <input type="number" id="niif_ead" value="10000" class="w-full pl-8 p-3 bg-white border border-blue-200 rounded-xl font-mono text-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <p class="text-xs text-blue-600 mt-2">Saldo total que debe el cliente.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-purple-50 p-6 rounded-2xl border border-purple-100">
                                <label class="block text-sm font-bold text-purple-900 mb-2">2. PD (%)</label>
                                <div class="relative">
                                    <input type="number" id="niif_pd" value="5.5" step="0.1" class="w-full pr-8 p-3 bg-white border border-purple-200 rounded-xl font-mono text-lg focus:ring-2 focus:ring-purple-500 outline-none">
                                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-purple-400 font-bold">%</span>
                                </div>
                                <p class="text-xs text-purple-600 mt-2">Probabilidad de impago.</p>
                            </div>
                            <div class="bg-orange-50 p-6 rounded-2xl border border-orange-100">
                                <label class="block text-sm font-bold text-orange-900 mb-2">3. LGD (%)</label>
                                <div class="relative">
                                    <input type="number" id="niif_lgd" value="45" step="1" class="w-full pr-8 p-3 bg-white border border-orange-200 rounded-xl font-mono text-lg focus:ring-2 focus:ring-orange-500 outline-none">
                                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-orange-400 font-bold">%</span>
                                </div>
                                <p class="text-xs text-orange-600 mt-2">Lo que perderías realmente.</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-900 rounded-[2rem] p-8 text-white flex flex-col justify-center items-center text-center relative overflow-hidden shadow-2xl">
                        <div class="absolute top-0 right-0 w-full h-full bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-red-900/40 via-slate-900 to-slate-900"></div>
                        <div class="relative z-10">
                            <i data-lucide="trending-down" class="w-12 h-12 text-red-500 mb-4 mx-auto"></i>
                            <span class="text-slate-400 uppercase tracking-widest text-xs font-bold mb-2 block">Pérdida Esperada (ECL)</span>
                            <div class="flex items-baseline justify-center gap-1">
                                <span class="text-4xl font-bold text-slate-500">$</span>
                                <div id="niif_result" class="text-6xl font-black tracking-tighter text-white">0</div>
                            </div>
                            <div class="mt-8 p-4 bg-white/5 rounded-xl text-left w-full max-w-sm mx-auto border border-white/10">
                                <div class="flex justify-between text-sm font-mono mb-1">
                                    <span class="text-blue-300">EAD</span>
                                    <span id="disp_ead">$10,000</span>
                                </div>
                                <div class="flex justify-between text-sm font-mono mb-1">
                                    <span class="text-purple-300">x PD</span>
                                    <span id="disp_pd">5.5%</span>
                                </div>
                                <div class="flex justify-between text-sm font-mono">
                                    <span class="text-orange-300">x LGD</span>
                                    <span id="disp_lgd">45%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB: PROCYCLICAL -->
        <div id="proc" class="tab-content slide-up space-y-6">
            <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2 text-purple-900">
                    <i data-lucide="bar-chart-3" class="text-purple-600 w-6 h-6"></i> La Regla Procíclica
                </h2>
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <div class="space-y-4">
                        <p class="text-slate-600 leading-relaxed">
                            Es un mecanismo de "ahorro forzoso". La SBS obliga a los bancos a guardar provisiones extra cuando la economía va bien.
                        </p>
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                            <h4 class="font-bold text-purple-800 mb-2 text-sm uppercase">Activación</h4>
                            <ul class="space-y-3">
                                <li class="flex gap-3 text-sm items-start">
                                    <div class="w-6 h-6 rounded-full bg-white text-purple-600 border border-purple-200 flex items-center justify-center shrink-0 font-bold text-xs">A</div>
                                    <span>PBI (30 meses) <strong>≥ 5%</strong>.</span>
                                </li>
                                <li class="flex gap-3 text-sm items-start">
                                    <div class="w-6 h-6 rounded-full bg-white text-purple-600 border border-purple-200 flex items-center justify-center shrink-0 font-bold text-xs">B</div>
                                    <span>PBI (12 meses) crece <strong>2%</strong> más que el año anterior.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-2xl border border-dashed border-slate-300 relative h-64 flex items-end justify-center gap-4">
                        <div class="w-8 bg-slate-300 h-1/4 rounded-t-md"></div>
                        <div class="w-8 bg-slate-300 h-1/3 rounded-t-md"></div>
                        <div class="w-8 bg-slate-300 h-2/5 rounded-t-md"></div>
                        <div class="w-8 bg-purple-400 h-3/5 rounded-t-md relative group">
                            <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-purple-600 text-white text-xs p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">PBI &gt; 5%</div>
                        </div>
                        <div class="w-8 bg-purple-500 h-3/4 rounded-t-md animate-pulse"></div>
                        <div class="w-8 bg-purple-600 h-full rounded-t-md"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- SCRIPTS -->
    <script>
        // --- DATA STRUCTURES (SBS) ---
        const creditTypes = {
            comercial: { name: 'Corporativos / Gran Empresa', baseRate: 0.7, procRate: 0.45 },
            mediana: { name: 'Mediana Empresa', baseRate: 1.0, procRate: 0.30 },
            pequena: { name: 'Pequeña / Micro Empresa', baseRate: 1.0, procRate: 0.50 },
            consumo_rev: { name: 'Consumo Revolvente', baseRate: 1.0, procRate: 1.50 },
            consumo_no_rev: { name: 'Consumo No Revolvente', baseRate: 1.0, procRate: 1.00 },
            hipotecario: { name: 'Hipotecario Vivienda', baseRate: 0.7, procRate: 0.40 }
        };

        const categoryRules = {
            no_minorista: {
                title: "Créditos Corporativos, Grandes y Medianas Empresas",
                rules: {
                    '0': { days: 'Al día', desc: 'Flujo de caja sólido. Nivel de endeudamiento bajo.' },
                    '1': { days: '< 60 días', desc: 'Atrasos ocasionales. Flujo de caja sensible.' },
                    '2': { days: '60 - 120 días', desc: 'Flujo de caja insuficiente. Situación financiera débil.' },
                    '3': { days: '120 - 365 días', desc: 'Situación crítica. Flujo de caja negativo.' },
                    '4': { days: '> 365 días', desc: 'Insolvencia decretada o pérdida total.' }
                }
            },
            minorista: {
                title: "Pequeña Empresa, Microempresa y Consumo",
                rules: {
                    '0': { days: '< 8 días', desc: 'Pago puntual o atraso mínimo.' },
                    '1': { days: '9 - 30 días', desc: 'Incumplimiento leve.' },
                    '2': { days: '31 - 60 días', desc: 'Deterioro moderado.' },
                    '3': { days: '61 - 120 días', desc: 'Deterioro significativo.' },
                    '4': { days: '> 120 días', desc: 'Irrecuperable.' }
                }
            },
            hipotecario: {
                title: "Crédito Hipotecario para Vivienda",
                rules: {
                    '0': { days: '< 30 días', desc: 'Pago puntual.' },
                    '1': { days: '31 - 60 días', desc: 'Incumplimiento leve.' },
                    '2': { days: '61 - 120 días', desc: 'Deterioro moderado.' },
                    '3': { days: '121 - 365 días', desc: 'Deterioro significativo.' },
                    '4': { days: '> 365 días', desc: 'Irrecuperable (Proceso judicial).' }
                }
            }
        };

        const categories = {
            '0': { name: 'Normal', color: 'bg-green-500', t1: 0 },
            '1': { name: 'CPP', color: 'bg-yellow-400', t1: 5 },
            '2': { name: 'Deficiente', color: 'bg-orange-400', t1: 25 },
            '3': { name: 'Dudoso', color: 'bg-orange-600', t1: 60 },
            '4': { name: 'Pérdida', color: 'bg-red-600', t1: 100 }
        };

        const catNames = { '0': 'Normal', '1': 'CPP', '2': 'Deficiente', '3': 'Dudoso', '4': 'Pérdida' };
        const catColors = { '0': 'text-green-600', '1': 'text-yellow-600', '2': 'text-orange-500', '3': 'text-orange-700', '4': 'text-red-600' };

        const guaranteeRates = {
            none: { '1': 5, '2': 25, '3': 60, '4': 100 },
            preferida: { '1': 2.5, '2': 12.5, '3': 30, '4': 60 },
            muy_rapida: { '1': 1.25, '2': 6.25, '3': 15, '4': 30 }
        };

        let state = {
            activeTab: 'home',
            calcType: 'comercial',
            calcCategory: '0',
            hasGuarantee: 'none',
            isProcyclical: true,
            catFilter: 'minorista',
            externalBanks: [{ share: 70, category: '3' }] // Initial default external bank
        };

        function switchTab(tabId) {
            state.activeTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('bg-slate-900', 'text-white', 'shadow-md');
                    btn.classList.remove('text-slate-500', 'hover:bg-slate-100');
                } else {
                    btn.classList.remove('bg-slate-900', 'text-white', 'shadow-md');
                    btn.classList.add('text-slate-500', 'hover:bg-slate-100');
                }
            });

            if (tabId === 'categories') renderCategories();
            if (tabId === 'calculator') renderCalculatorButtons();
            if (tabId === 'alignment') {
                calcInternalAlignment();
                renderExternalBanks();
            }
            
            lucide.createIcons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- RENDERERS ---
        function setCatFilter(filter) {
            state.catFilter = filter;
            renderCategories();
        }

        function renderCategories() {
            ['no_minorista', 'minorista', 'hipotecario'].forEach(f => {
                const btn = document.getElementById(`btn-${f}`);
                if (state.catFilter === f) {
                    btn.classList.add('bg-blue-100', 'text-blue-700');
                    btn.classList.remove('text-slate-500', 'hover:bg-slate-50');
                } else {
                    btn.classList.remove('bg-blue-100', 'text-blue-700');
                    btn.classList.add('text-slate-500', 'hover:bg-slate-50');
                }
            });

            const activeRules = categoryRules[state.catFilter];
            document.getElementById('cat-rules-title').textContent = activeRules.title;

            const listContainer = document.getElementById('categories-list');
            listContainer.innerHTML = '';

            Object.entries(categories).forEach(([key, val]) => {
                const rule = activeRules.rules[key];
                const rate = guaranteeRates.none[key] || creditTypes.comercial.baseRate;
                const html = `
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col md:flex-row gap-6 items-start md:items-center hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 min-w-[200px]">
                            <div class="w-4 h-12 rounded-full ${val.color} shrink-0"></div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-800">${val.name}</h3>
                                <span class="text-xs font-mono text-slate-400">Categoría ${key}</span>
                            </div>
                        </div>
                        <div class="flex-1 grid md:grid-cols-2 gap-4 w-full">
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <span class="text-xs font-bold text-slate-400 uppercase block mb-1">Criterio de Atraso</span>
                                <span class="text-slate-800 font-bold">${rule.days}</span>
                            </div>
                            <div>
                                <span class="text-xs font-bold text-slate-400 uppercase block mb-1">Descripción SBS</span>
                                <p class="text-sm text-slate-600">${rule.desc}</p>
                            </div>
                        </div>
                        <div class="text-right min-w-[100px] hidden md:block">
                            <div class="text-xs text-slate-400 font-bold mb-1">Provisión (Sin Garantía)</div>
                            <div class="text-2xl font-black text-slate-800">${rate}%</div>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderCalculatorButtons() {
            const container = document.getElementById('calc-cat-buttons');
            container.innerHTML = '';
            Object.entries(categories).forEach(([key, val]) => {
                const isActive = state.calcCategory === key;
                const activeClasses = `${val.color} border-transparent text-white shadow-md transform scale-105`;
                const inactiveClasses = 'bg-white border-slate-100 text-slate-500 hover:border-slate-300';
                const btn = document.createElement('button');
                btn.className = `px-3 py-3 rounded-xl text-sm font-bold transition-all border-2 ${isActive ? activeClasses : inactiveClasses}`;
                btn.textContent = val.name;
                btn.onclick = () => {
                    state.calcCategory = key;
                    renderCalculatorButtons();
                    calculateProvision();
                };
                container.appendChild(btn);
            });

            const isNormal = state.calcCategory === '0';
            const procControl = document.getElementById('procyclical-control');
            const guarControl = document.getElementById('guarantee-control');

            if (isNormal) {
                procControl.classList.remove('hidden');
                procControl.classList.add('flex');
                guarControl.classList.add('hidden');
            } else {
                procControl.classList.add('hidden');
                procControl.classList.remove('flex');
                guarControl.classList.remove('hidden');
            }
            calculateProvision();
        }

        function calculateProvision() {
            const isNormal = state.calcCategory === '0';
            const type = creditTypes[state.calcType];
            let total = 0, base = 0, proc = 0, specific = 0;

            if (isNormal) {
                base = type.baseRate;
                if (state.isProcyclical) proc = type.procRate;
                total = base + proc;
            } else {
                total = guaranteeRates[state.hasGuarantee][state.calcCategory];
                specific = total;
            }

            document.getElementById('resultTotal').textContent = total.toFixed(2);
            document.getElementById('resultBase').textContent = base.toFixed(2) + '%';
            
            const rowProc = document.getElementById('rowProc');
            if (proc > 0) {
                rowProc.classList.remove('hidden');
                rowProc.classList.add('flex');
                document.getElementById('resultProc').textContent = '+' + proc.toFixed(2) + '%';
            } else {
                rowProc.classList.add('hidden');
                rowProc.classList.remove('flex');
            }

            const rowSpecific = document.getElementById('rowSpecific');
            if (specific > 0) {
                rowSpecific.classList.remove('hidden');
                rowSpecific.classList.add('flex');
                document.getElementById('resultSpecific').textContent = specific.toFixed(2) + '%';
            } else {
                rowSpecific.classList.add('hidden');
                rowSpecific.classList.remove('flex');
            }
        }

        // --- NIIF 9 CALCULATOR ---
        function calculateNIIF9() {
            const ead = parseFloat(document.getElementById('niif_ead').value) || 0;
            const pd = parseFloat(document.getElementById('niif_pd').value) || 0;
            const lgd = parseFloat(document.getElementById('niif_lgd').value) || 0;
            
            const ecl = ead * (pd / 100) * (lgd / 100);
            
            document.getElementById('niif_result').textContent = ecl.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('disp_ead').textContent = '$' + ead.toLocaleString('en-US');
            document.getElementById('disp_pd').textContent = pd + '%';
            document.getElementById('disp_lgd').textContent = lgd + '%';
        }

        // --- INTERNAL ALIGNMENT ---
        function calcInternalAlignment() {
            const valA = parseInt(document.getElementById('prodA_class').value);
            const valB = parseInt(document.getElementById('prodB_class').value);
            const maxVal = Math.max(valA, valB);
            
            const resultDiv = document.getElementById('internal_result');
            resultDiv.textContent = catNames[maxVal];
            resultDiv.className = `text-3xl font-black mt-2 mb-1 ${catColors[maxVal].replace('text-', 'text-')}`;
            if(maxVal === 0) resultDiv.style.color = '#4ade80'; 
            else if(maxVal === 1) resultDiv.style.color = '#facc15'; 
            else if(maxVal === 2) resultDiv.style.color = '#fb923c'; 
            else if(maxVal === 3) resultDiv.style.color = '#c2410c'; 
            else resultDiv.style.color = '#f87171'; 
        }

        // --- EXTERNAL ALIGNMENT (DYNAMIC) ---
        function getCatColorClass(cat) {
            const map = {
                '0': 'text-green-700 bg-green-50 border-green-200',
                '1': 'text-yellow-700 bg-yellow-50 border-yellow-200',
                '2': 'text-orange-700 bg-orange-50 border-orange-200',
                '3': 'text-orange-900 bg-orange-100 border-orange-300',
                '4': 'text-red-700 bg-red-50 border-red-200'
            };
            return map[cat] || '';
        }

        function renderExternalBanks() {
            const container = document.getElementById('external_banks_container');
            container.innerHTML = '';
            
            let totalExternal = 0;

            state.externalBanks.forEach((bank, index) => {
                totalExternal += parseFloat(bank.share) || 0;
                
                const html = `
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex items-center gap-3 animate-in fade-in slide-in-from-left-4">
                        <div class="bg-red-100 p-2 rounded-lg text-red-600 shrink-0">
                            <i data-lucide="building-2" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between mb-1">
                                <span class="text-xs font-bold text-slate-700">Banco Externo ${index + 1}</span>
                                <button onclick="removeExternalBank(${index})" class="text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="number" value="${bank.share}" min="0" max="100" class="w-full bg-slate-50 border border-slate-200 rounded text-xs p-1.5 pl-2 font-mono font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none" oninput="updateBankShare(${index}, this.value)">
                                    <span class="absolute right-6 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]">%</span>
                                </div>
                                <select class="bg-white border text-xs p-1 rounded-lg font-bold outline-none cursor-pointer ${getCatColorClass(bank.category)}" onchange="updateBankCat(${index}, this.value)">
                                    <option value="0" ${bank.category == '0' ? 'selected' : ''}>Normal</option>
                                    <option value="1" ${bank.category == '1' ? 'selected' : ''}>CPP</option>
                                    <option value="2" ${bank.category == '2' ? 'selected' : ''}>Deficiente</option>
                                    <option value="3" ${bank.category == '3' ? 'selected' : ''}>Dudoso</option>
                                    <option value="4" ${bank.category == '4' ? 'selected' : ''}>Pérdida</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });

            // Update My Share
            const myShare = 100 - totalExternal;
            const myShareDisplay = document.getElementById('my_share_display');
            const warning = document.getElementById('share_warning');
            
            if (myShare < 0) {
                myShareDisplay.textContent = "Error";
                myShareDisplay.classList.add('text-red-500');
                warning.classList.remove('hidden');
            } else {
                myShareDisplay.textContent = myShare.toFixed(0) + '%';
                myShareDisplay.classList.remove('text-red-500');
                warning.classList.add('hidden');
            }

            lucide.createIcons();
            calcExternalAlignment();
        }

        function addExternalBank() {
            state.externalBanks.push({ share: 10, category: '0' });
            renderExternalBanks();
        }

        function removeExternalBank(index) {
            state.externalBanks.splice(index, 1);
            renderExternalBanks();
        }

        function updateBankShare(index, value) {
            state.externalBanks[index].share = parseFloat(value) || 0;
            renderExternalBanks(); // Re-render to update total
        }

        function updateBankCat(index, value) {
            state.externalBanks[index].category = value;
            renderExternalBanks(); // Re-render to update colors
        }

        function calcExternalAlignment() {
            const myCat = parseInt(document.getElementById('my_bank_cat').value);
            let worstCat = myCat;
            let causeBank = null;

            // Check all external banks
            state.externalBanks.forEach((bank, index) => {
                const cat = parseInt(bank.category);
                const share = parseFloat(bank.share);
                
                // Rule: If external bank has >= 20% share AND worse category
                if (share >= 20 && cat > worstCat) {
                    worstCat = cat;
                    causeBank = `Banco Externo ${index + 1}`;
                }
            });

            const resultTitle = document.getElementById('external_result_title');
            const resultDesc = document.getElementById('external_result_desc');
            const iconContainer = document.getElementById('align_icon_container');

            if (worstCat > myCat) {
                // Must Align
                resultTitle.textContent = "¡SÍ, ALINEAR!";
                resultTitle.className = "text-3xl font-black mb-3 text-red-400";
                resultDesc.innerHTML = `Debes reclasificar al cliente como <strong class="text-white text-lg">${catNames[worstCat]}</strong>.<br><br>Causa: <strong>${causeBank}</strong> tiene >20% de deuda y peor calificación.`;
                iconContainer.innerHTML = '<i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 animate-pulse"></i>';
            } else {
                // No Alignment needed
                resultTitle.textContent = "TODO OK";
                resultTitle.className = "text-3xl font-black mb-3 text-green-400";
                
                let subtext = "Nadie con más del 20% tiene peor nota.";
                if (myCat > 0) subtext = "Tu calificación ya es conservadora.";
                
                resultDesc.innerHTML = `Mantienes tu calificación actual: <strong class="text-white">${catNames[myCat]}</strong>.<br><span class="text-xs opacity-70">${subtext}</span>`;
                iconContainer.innerHTML = '<i data-lucide="check-circle" class="w-16 h-16 text-green-500"></i>';
            }
            lucide.createIcons();
        }

        // Listeners
        document.getElementById('calcType').addEventListener('change', (e) => { state.calcType = e.target.value; calculateProvision(); });
        document.getElementById('hasGuarantee').addEventListener('change', (e) => { state.hasGuarantee = e.target.value; calculateProvision(); });
        document.getElementById('isProcyclical').addEventListener('change', (e) => { state.isProcyclical = e.target.checked; calculateProvision(); });
        
        ['niif_ead', 'niif_pd', 'niif_lgd'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateNIIF9);
        });

        // Internal Alignment Listeners
        document.getElementById('prodA_class').addEventListener('change', calcInternalAlignment);
        document.getElementById('prodB_class').addEventListener('change', calcInternalAlignment);

        // INIT
        lucide.createIcons();
        calculateProvision();
        calculateNIIF9();
        
        // Init External Banks (if tab is loaded directly, though switchTab handles it)
    </script>
</body>
</html>